<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GW-BASIC with js-dos</title>
  <style>
    body { margin: 0; background: #000; color: #0f0; font-family: monospace; }
    #dos-root { width: 100vw; height: 80vh; background: #111; }
    #keyboard { position: fixed; bottom: 0; width: 100%; display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; background: #222; padding: 6px; }
    .key { background: #333; color: white; text-align: center; padding: 12px; border-radius: 6px; }
    .shift-active { background: #555; }
    #audio-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); color: #fff; font-size: 1.2em; cursor: pointer; }
  </style>
  <script src="https://js-dos.com/6.22/current/js-dos.js"></script>
</head>
<body>
  <div id="dos-root"></div>

  <div id="keyboard">
    <div class="key" onclick="sendKeys(65)">A</div>
    <div class="key" onclick="sendKeys(66)">B</div>
    <div class="key" onclick="sendKeys(67)">C</div>
    <div class="key" id="shift-key" onclick="sendKeys(16)">Shift</div>
    <div class="key" onclick="sendKeys(13)">‚èé</div>
    <div class="key" onclick="sendKeys(32)">Space</div>
  </div>

  <div id="audio-overlay">üîä Tap to Enable Audio</div>

  <script>
    let ci = null;
    let shiftActive = false;
    const shiftKeyEl = document.getElementById("shift-key");

    JS_DOS(document.getElementById("dos-root"), {
      wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js"
    }).ready((fs, main) => {
      fs.extract("basic.zip").then(() => {
        main(["-c","mount d .","-c","d:","-c","cd gwbasic","-c","gwbasic"])
          .then(client => ci = client);
      });
    });

    function sendKeys(code) {
      if (!ci) return;

      if (code === 16) {
        shiftActive = !shiftActive;
        shiftKeyEl.classList.toggle("shift-active", shiftActive);
        return;
      }

      if (shiftActive && code >= 65 && code <= 90) {
        ci.simulateKeyPress(code); // uppercase A-Z
        shiftActive = false;
        shiftKeyEl.classList.remove("shift-active");
      } else {
        ci.simulateKeyPress(code);
      }

      if (navigator.vibrate) navigator.vibrate(20);
    }

    // üîä Audio unlock
    let audioContext;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        SDL.audioContext = audioContext;
      }
      if (audioContext.state === "suspended") {
        audioContext.resume().then(() => {
          console.log("‚úÖ AudioContext resumed");
        });
      }
      document.getElementById("audio-overlay").style.display = "none";
    }

    document.getElementById("audio-overlay").addEventListener("click", initAudio, { once: true });

    SDL.audio.pushAudio = function (ptr, size) {
      if (!SDL.audioContext) return;
      if (SDL.audioContext.state === "suspended") return;

      try {
        const data = SDL.audio.mixBuffer(ptr, size);
        const buffer = SDL.audioContext.createBuffer(2, data[0].length, SDL.audioContext.sampleRate);
        buffer.getChannelData(0).set(data[0]);
        buffer.getChannelData(1).set(data[1]);

        const source = SDL.audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(SDL.audioContext.destination);

        const playtime = Math.max(SDL.audioContext.currentTime, SDL.audio.nextPlayTime || 0);
        source.start(playtime);

        SDL.audio.nextPlayTime = playtime + SDL.audio.bufferDurationSecs;
      } catch (e) {
        console.log("‚ùå Audio error: " + e.toString());
      }
    };
  </script>
</body>
</html>
