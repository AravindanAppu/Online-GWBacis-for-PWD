<script>
const dosRoot = document.getElementById("dos-root");
let ci = null;
let shiftActive = false; // âœ… Track shift toggle
const shiftKeyEl = document.getElementById("shift-key");

Dos(dosRoot, {
  wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js"
}).ready((fs, main) => {
  fs.extract("basic.zip").then(() => {
    main(["-c","mount d .","-c","d:","-c","cd gwbasic","-c","gwbasic"])
      .then(client => ci = client);
  });
});

// ðŸ”‘ Low-level key event generator
function simulateKeyEvent(keyCode, pressed) {
  const eventType = pressed ? "keydown" : "keyup";
  const event = document.createEvent("KeyboardEvent");

  if (event.initKeyboardEvent) {
    event.initKeyboardEvent(
      eventType, true, true, window,
      false, false, false, false,
      keyCode, 0
    );
  } else {
    event.initKeyEvent(
      eventType, true, true, window,
      false, false, false, false,
      keyCode, 0
    );
  }

  // Patch keyCode + which so DOSBox can see correct codes
  Object.defineProperty(event, "keyCode", { get: () => keyCode });
  Object.defineProperty(event, "which", { get: () => keyCode });

  document.dispatchEvent(event);
}

// ðŸ”‘ Press + release in one call
function simulateKeyPress(keyCode) {
  simulateKeyEvent(keyCode, true);
  simulateKeyEvent(keyCode, false);
}

function sendKeys(code) {
  if (!ci) return;

  if (code === 16) { 
    // Toggle SHIFT
    shiftActive = !shiftActive;
    shiftKeyEl.classList.toggle("shift-active", shiftActive);
    return;
  }

  if (shiftActive) {
    if (code >= 65 && code <= 90) {
      simulateKeyPress(code); // already uppercase
    } else {
      const shiftedMap = {
        49: 33,   // 1 â†’ !
        50: 64,   // 2 â†’ @
        51: 35,   // 3 â†’ #
        52: 36,   // 4 â†’ $
        53: 37,   // 5 â†’ %
        54: 94,   // 6 â†’ ^
        55: 38,   // 7 â†’ &
        56: 42,   // 8 â†’ *
        57: 40,   // 9 â†’ (
        48: 41,   // 0 â†’ )
        186: 58,  // ; â†’ :
        222: 34,  // ' â†’ "
        188: 60,  // , â†’ <
        190: 62,  // . â†’ >
        191: 63,  // / â†’ ?
        189: 95,  // - â†’ _
        187: 43   // = â†’ +
      };
      if (shiftedMap[code]) {
        simulateKeyPress(shiftedMap[code]);
      } else {
        simulateKeyPress(code);
      }
    }
    shiftActive = false;
    shiftKeyEl.classList.remove("shift-active");
  } else {
    simulateKeyPress(code);
  }

  if (navigator.vibrate) navigator.vibrate(20);
}

// ðŸ”Š Fix for AudioContext autoplay policy
document.addEventListener("click", () => {
  if (ci && ci.audioContext && ci.audioContext.state === "suspended") {
    ci.audioContext.resume();
  }
}, { once: true });
</script>
