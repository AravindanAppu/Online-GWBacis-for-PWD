<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GW-BASIC with Virtual Keyboard</title>
<link rel="stylesheet" href="jsdos/js-dos.css">
<style>
  body, html { margin:0; height:100%; background:#000; display:flex; flex-direction:column; }
  #dosbox { flex:1; width:100%; height:100%; display:block; }
  #keyboard { background:#222; padding:10px; display:grid; grid-template-columns: repeat(14, 1fr); gap:4px; }
  .key { background:#444; color:#fff; border:none; border-radius:4px; padding:8px; font-size:14px; cursor:pointer; }
  .key:active, .key.active { background:#888; }
  .wide { grid-column: span 2; }
  .space { grid-column: span 5; }
</style>
</head>
<body>
<canvas id="dosbox"></canvas>
<div id="keyboard"></div>

<script src="jsdos/js-dos.js"></script>
<script>
let ci;
const canvas = document.getElementById("dosbox");

// Start js-dos
Dos(canvas, { wdosboxUrl: "jsdos/wdosbox.js" })
.ready((fs, main, control) => {
  ci = control;
  fs.extract("basic.zip").then(() => {
    main(["-c", "mount c .", "-c", "c:", "-c", "cd gwbasic", "-c", "gwbasic"]);
  });
});

// Keyboard layout
const layout = [
  ["Esc","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","-","=","Backspace"],
  ["Tab","1","2","3","4","5","6","7","8","9","0","-","=","Enter"],
  ["Caps","Q","W","E","R","T","Y","U","I","O","P","[","]","\\",""],
  ["Shift","A","S","D","F","G","H","J","K","L",";","'","","Shift",""],
  ["Z","X","C","V","B","N","M",",",".","/","","","","",""],
  ["Ctrl","Alt","Space","Alt","Ctrl","","","","","","","","",""]
];

// Symbols for Shift
const shiftSymbols = {
  "1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")",
  "-":"_","=":"+","[":"{","]":"}","\\":"|",";":":","'":'"',",":"<",".":">","/":"?"
};

let shiftActive = false;
let capsActive = false;

const kb = document.getElementById("keyboard");

// Build keyboard
layout.forEach(row => {
  row.forEach(k => {
    if(k === "") { kb.appendChild(document.createElement("div")); return; }
    const btn = document.createElement("button");
    btn.className = "key";
    btn.textContent = k;
    if(k==="Backspace"||k==="Enter") btn.classList.add("wide");
    if(k==="Space") btn.classList.add("space");

    btn.addEventListener("click", () => sendKey(k, btn));
    kb.appendChild(btn);
  });
});

function sendKey(k, btn) {
  if(!ci) return;

  // Toggle shift
  if(k === "Shift") {
    shiftActive = !shiftActive;
    btn.classList.toggle("active", shiftActive);
    return;
  }

  // Toggle caps
  if(k === "Caps") {
    capsActive = !capsActive;
    btn.classList.toggle("active", capsActive);
    return;
  }

  // Determine character to send
  let char = k;

  // Apply Caps/Shift for letters
  if(/[A-Z]/i.test(char)) {
    if((shiftActive && !capsActive) || (!shiftActive && capsActive)) char = char.toUpperCase();
    else char = char.toLowerCase();
  } else if(shiftActive && shiftSymbols[char]) {
    char = shiftSymbols[char];
  }

  // Send key
  if(char.length === 1) {
    ci.sendKeyPress(char.charCodeAt(0));
  } else {
    // Non-printable keys
    const special = { "Enter":13, "Backspace":8, "Tab":9, "Esc":27, "Space":32 };
    if(special[char]) {
      ci.sendKeyEvent({type:"keydown", code:special[char]});
      ci.sendKeyEvent({type:"keyup", code:special[char]});
    }
  }

  // Auto-reset shift
  if(shiftActive && !/[A-Z]/i.test(k)) shiftActive = false;
  document.querySelectorAll(".key.active").forEach(b => b.classList.remove("active"));
}
</script>
</body>
</html>
