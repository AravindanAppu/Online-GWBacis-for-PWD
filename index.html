<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GW‑BASIC – JS‑DOS with Soft Keyboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0,
       maximum-scale=1.0, user-scalable=no">
<script src="https://js-dos.com/6.22/current/js-dos.js"></script>

<style>
    body {
        margin:0; background:#000; color:#ccc;
        font-family:"Courier New",monospace;
        height:100vh; overflow:hidden;
        display:flex; flex-direction:column;
        align-items:center; justify-content:center;
    }
    #dos-root { width:100vw; height:45vh; border:2px solid #666; }
    #keyboard { width:100vw; height:55vh; background:#333;
        display:grid; grid-template-columns:repeat(10,1fr);
        gap:2px; padding:2px; box-sizing:border-box; }
    .key {
        background:#444; border:1px solid #222; border-radius:4px;
        font-size:1.3em; color:#ccc; display:flex;
        align-items:center; justify-content:center;
        user-select:none; -webkit-user-select:none;
        cursor:pointer; transition:background .1s;
    }
    .key:active { background:#777; transform:translateY(1px); }
    .key { background:#555; }
</style>
</head>

<body>
    <canvas id="dos-root"></canvas>
    <div id="keyboard"></div>

<script>
/* ---------- 1.  Layout definition ----------------------------------- */
const rows = [
    // row 0 – numbers and symbols
    [{norm:'1',sh:'!',code:49},{norm:'2',sh:'@',code:50},
     {norm:'3',sh:'#',code:51},{norm:'4',sh:'$',code:52},
     {norm:'5',sh:'%',code:53},{norm:'6',sh:'^',code:54},
     {norm:'7',sh:'&',code:55},{norm:'8',sh:'*',code:56},
     {norm:'9',sh:'(',code:57},{norm:'0',sh:')',code:48}],

    // row 1 – Q‑W‑E‑R‑T … P
    [{norm:'Q',sh:'Q',code:81},{norm:'W',sh:'W',code:87},
     {norm:'E',sh:'E',code:69},{norm:'R',sh:'R',code:82},
     {norm:'T',sh:'T',code:84},{norm:'Y',sh:'Y',code:89},
     {norm:'U',sh:'U',code:85},{norm:'I',sh:'I',code:73},
     {norm:'O',sh:'O',code:79},{norm:'P',sh:'P',code:80}],

    // row 2 – A‑S‑D‑F‑G … L
    [{norm:'A',sh:'A',code:65},{norm:'S',sh:'S',code:83},
     {norm:'D',sh:'D',code:68},{norm:'F',sh:'F',code:70},
     {norm:'G',sh:'G',code:71},{norm:'H',sh:'H',code:72},
     {norm:'J',sh:'J',code:74},{norm:'K',sh:'K',code:75},
     {norm:'L',sh:'L',code:76},
     {norm:'⏎',sh:'⏎',code:13,wide:2,cls:'key shift'}],

    // row 3 – Z‑X‑C‑V‑B‑N‑M  + Backspace
    [{norm:'SHIFT',sh:'SHIFT',code:16,wide:2,cls:'key shift'},
     {norm:'Z',sh:'Z',code:90},{norm:'X',sh:'X',code:88},
     {norm:'C',sh:'C',code:67},{norm:'V',sh:'V',code:86},
     {norm:'B',sh:'B',code:66},{norm:'N',sh:'N',code:78},
     {norm:'M',sh:'M',code:77},
     {norm:'←',sh:'←',code:8,wide:2,cls:'key'}],

    // row 4 – space and punctuation
    [{norm:'`',sh:'~',code:192},
     {norm:'[',sh:'{',code:219},
     {norm:']',sh:'}',code:221},
     {norm:';',sh:':',code:186},
     {norm:"'",sh:'"',code:222},
     {norm:',',sh:'<',code:188},
     {norm:'.',sh:'>',code:190},
     {norm:'/',sh:'?',code:191},
     {norm:'SPACE',sh:'SPACE',code:32,wide:6,cls:'key'}]
];

/* ---------- 2.  Build the keyboard --------------------------------- */
const kb = document.getElementById('keyboard');

rows.forEach(row => {
    row.forEach(k => {
        const btn = document.createElement('div');
        btn.className = k.cls ? k.cls : 'key';
        btn.dataset.code = k.code;
        btn.dataset.norm = k.norm;
        btn.dataset.shift = k.sh;
        btn.textContent = k.norm;
        if (k.wide) btn.style.gridColumn = `span ${k.wide}`;
        btn.addEventListener('click', () => onKeyPress(btn));
        kb.appendChild(btn);
    });
});

/* ---------- 3.  Shift handling ------------------------------------- */
let shiftActive = false;

function toggleShift() {
    shiftActive = !shiftActive;
    refreshShift();
}

/* change the visual label according to the current shift state */
function refreshShift() {
    const keys = document.querySelectorAll('#keyboard .key');
    keys.forEach(k => {
        const norm = k.dataset.norm;
        const sh   = k.dataset.shift;
        // Keep special keys (SHIFT, SPACE, ENTER, BACKSPACE) unchanged
        if (['SHIFT','SPACE','←','⏎'].includes(norm)) return;
        k.textContent = shiftActive ? sh : norm;
    });
}

/* ---------- 4.  Send a key to the emulator ------------------------ */
function sendKey(code) {
    if (ci) ci.simulateKeyPress(code);
}

/* ---------- 5.  Click handler -------------------------------------- */
function onKeyPress(btn) {
    const code = Number(btn.dataset.code);
    const label = btn.textContent;

    if (code === 16) {                 // Shift key
        toggleShift();
        return;
    }

    // Normal character – send it
    sendKey(code);

    // If we were in shift mode, turn it off after the key press
    if (shiftActive && code !== 16) {
        shiftActive = false;
        refreshShift();
    }
}

/* ---------- 6.  JS‑DOS setup -------------------------------------- */
let ci = null;               // client instance
const dosRoot = document.getElementById('dos-root');

Dos(dosRoot, {
    wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js"
}).ready((fs, main) => {
    fs.extract("basic.zip").then(() => {
        main([
            "-c", "mount d .",
            "-c", "d:",
            "-c", "cd gwbasic",
            "-c", "gwbasic"
        ]).then(client => {
            ci = client;
            dosRoot.focus();               // give the canvas initial focus
        });
    });
});

/* ---------- 7.  Keep focus when user taps canvas ----------------- */
dosRoot.addEventListener('click', () => dosRoot.focus());

</script>
</body>
</html>
