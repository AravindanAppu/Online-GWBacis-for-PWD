<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>GW-BASIC with Virtual Keyboard</title>
  <link rel="stylesheet" href="jsdos/js-dos.css">
  <style>
    body, html { margin:0; height:100%; background:#000; display:flex; flex-direction:column; }
    #dosbox { flex:1; width:100%; height:100%; display:block; }
    #keyboard { background:#222; padding:10px; display:grid; grid-template-columns: repeat(14, 1fr); gap:4px; }
    .key { background:#444; color:#fff; border:none; border-radius:4px; padding:8px; font-size:14px; cursor:pointer; }
    .key:active { background:#666; }
    .wide { grid-column: span 2; }
    .space { grid-column: span 5; }
  </style>
</head>
<body>
  <canvas id="dosbox"></canvas>
  <div id="keyboard"></div>

  <script src="jsdos/js-dos.js"></script>
  <script>
    let ci;
    const canvas = document.getElementById("dosbox");

    Dos(canvas, { wdosboxUrl: "jsdos/wdosbox.js" })
      .ready((fs, main, control) => {
        ci = control;
        fs.extract("basic.zip").then(() => {
          main(["-c", "mount c .", "-c", "c:", "-c", "cd gwbasic", "-c", "gwbasic"]);
        });
      });

    // Keyboard layout
    const layout = [
      ["Esc","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","-","=","Backspace"],
      ["Tab","1","2","3","4","5","6","7","8","9","0","-","=","Enter"],
      ["Caps","Q","W","E","R","T","Y","U","I","O","P","[","]","\\",""],
      ["Shift","A","S","D","F","G","H","J","K","L",";","'","","Shift",""],
      ["Z","X","C","V","B","N","M",",",".","/","","","","",""],
      ["Ctrl","Alt","Space","Alt","Ctrl","","","","","","","","",""]
    ];

    // Key mapping for special keys
    const keymap = {
      "Backspace":8,"Tab":9,"Enter":13,"Esc":27,
      "Shift":16,"Ctrl":17,"Alt":18,"Caps":20,"Space":32,
      "ArrowLeft":37,"ArrowUp":38,"ArrowRight":39,"ArrowDown":40
    };

    let shiftActive = false;
    let capsActive = false;

    const kb = document.getElementById("keyboard");
    layout.forEach(row => {
      row.forEach(k => {
        if(k === "") {
          const empty = document.createElement("div");
          kb.appendChild(empty);
          return;
        }
        const btn = document.createElement("button");
        btn.className = "key";
        btn.textContent = k;
        if(k === "Backspace" || k === "Enter") btn.classList.add("wide");
        if(k === "Space") btn.classList.add("space");

        btn.addEventListener("click", () => sendKey(k));
        kb.appendChild(btn);
      });
    });

    function sendKey(k) {
      if(!ci) return;

      // Handle toggles
      if(k === "Shift") {
        shiftActive = !shiftActive;
        return;
      }
      if(k === "Caps") {
        capsActive = !capsActive;
        return;
      }

      let code = 0;

      if(keymap[k]) {
        code = keymap[k];
      } else if(k.length === 1) {
        let char = k;
        if(/[A-Z]/.test(char)) {
          if((shiftActive && !capsActive) || (!shiftActive && capsActive)) {
            char = char.toUpperCase();
          } else {
            char = char.toLowerCase();
          }
        } else {
          // Handle shift symbols
          if(shiftActive) {
            const shiftSymbols = {
              "1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")",
              "-":"_","=":"+","[":"{","]":"}","\\":"|",";":":","'":'"',",":"<",".":">","/":"?"
            };
            if(shiftSymbols[char]) char = shiftSymbols[char];
          }
        }
        code = char.charCodeAt(0);
      }

      if(code) {
        ci.sendKeyEvent({type:"keydown", code});
        ci.sendKeyEvent({type:"keyup", code});
      }

      if(shiftActive && k.length === 1) shiftActive = false; // reset shift after one key
    }
  </script>
</body>
</html>
