<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GW-BASIC Virtual Keyboard</title>
<link rel="stylesheet" href="jsdos/js-dos.css">
<style>
  body, html { margin:0; height:100%; background:#000; display:flex; flex-direction:column; }
  #dosbox { flex:1; width:100%; height:100%; display:block; }
  #keyboard { background:#222; padding:10px; display:grid; grid-template-columns: repeat(14, 1fr); gap:4px; }
  .key { background:#444; color:#fff; border:none; border-radius:4px; padding:8px; font-size:14px; cursor:pointer; }
  .key:active, .key.active { background:#888; }
  .wide { grid-column: span 2; }
  .space { grid-column: span 5; }
</style>
</head>
<body>
<canvas id="dosbox"></canvas>
<div id="keyboard"></div>

<script src="jsdos/js-dos.js"></script>
<script>
let ci;
const canvas = document.getElementById("dosbox");

Dos(canvas, { wdosboxUrl: "jsdos/wdosbox.js" })
.ready((fs, main, control) => {
  ci = control;
  fs.extract("basic.zip").then(() => {
    main(["-c", "mount c .", "-c", "c:", "-c", "cd gwbasic", "-c", "gwbasic"]);
  });
});

// Keyboard layout
const layout = [
  ["Esc","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","-","=","Backspace"],
  ["Tab","1","2","3","4","5","6","7","8","9","0","-","=","Enter"],
  ["Caps","Q","W","E","R","T","Y","U","I","O","P","[","]","\\",""],
  ["Shift","A","S","D","F","G","H","J","K","L",";","'","","Shift",""],
  ["Z","X","C","V","B","N","M",",",".","/","","","","",""],
  ["Ctrl","Alt","Space","Alt","Ctrl","","","","","","","","",""]
];

let shiftActive = false;
let capsActive = false;

// Map to browser key codes
const keyCodeMap = {
  "A":"KeyA","B":"KeyB","C":"KeyC","D":"KeyD","E":"KeyE","F":"KeyF","G":"KeyG","H":"KeyH","I":"KeyI","J":"KeyJ",
  "K":"KeyK","L":"KeyL","M":"KeyM","N":"KeyN","O":"KeyO","P":"KeyP","Q":"KeyQ","R":"KeyR","S":"KeyS","T":"KeyT",
  "U":"KeyU","V":"KeyV","W":"KeyW","X":"KeyX","Y":"KeyY","Z":"KeyZ",
  "1":"Digit1","2":"Digit2","3":"Digit3","4":"Digit4","5":"Digit5","6":"Digit6","7":"Digit7","8":"Digit8","9":"Digit9","0":"Digit0",
  "-":"Minus","=":"Equal","[":"BracketLeft","]":"BracketRight","\\":"Backslash",";":"Semicolon","'":"Quote",",":"Comma",".":"Period","/":"Slash",
  "Enter":"Enter","Backspace":"Backspace","Tab":"Tab","Esc":"Escape","Space":"Space"
};

// Symbols when Shift is active
const shiftSymbols = {
  "1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")",
  "-":"_","=":"+","[":"{","]":"}","\\":"|",";":":","'":'"',",":"<",".":">","/":"?"
};

const kb = document.getElementById("keyboard");

// Build keyboard
layout.forEach(row => {
  row.forEach(k => {
    if(k === "") { kb.appendChild(document.createElement("div")); return; }
    const btn = document.createElement("button");
    btn.className = "key";
    btn.textContent = k;
    if(k==="Backspace"||k==="Enter") btn.classList.add("wide");
    if(k==="Space") btn.classList.add("space");
    btn.addEventListener("click", () => sendKey(k, btn));
    kb.appendChild(btn);
  });
});

function sendKey(k, btn) {
  if(!ci) return;

  // Handle Shift toggle
  if(k === "Shift") {
    shiftActive = !shiftActive;
    btn.classList.toggle("active", shiftActive);
    return;
  }

  // Handle Caps toggle
  if(k === "Caps") {
    capsActive = !capsActive;
    btn.classList.toggle("active", capsActive);
    return;
  }

  // Determine the code to send
  let code = keyCodeMap[k];
  if(!code) return;

  let shiftNeeded = false;
  if(/[A-Z]/i.test(k)) {
    shiftNeeded = (shiftActive && !capsActive) || (!shiftActive && capsActive);
  } else if(shiftActive && shiftSymbols[k]) {
    k = shiftSymbols[k];
    shiftNeeded = true;
    code = keyCodeMap[k] || code;
  }

  // Press Shift if needed
  if(shiftNeeded) ci.sendKeyEvent({type:"keydown", code:"ShiftLeft"});

  ci.sendKeyEvent({type:"keydown", code});
  ci.sendKeyEvent({type:"keyup", code});

  if(shiftNeeded) ci.sendKeyEvent({type:"keyup", code:"ShiftLeft"});

  // Auto-reset Shift for single press
  if(shiftActive && !/[A-Z]/i.test(k)) shiftActive = false;
  document.querySelectorAll(".key.active").forEach(b => b.classList.remove("active"));
}
</script>
</body>
</html>
